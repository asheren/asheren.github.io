---
layout: post
title: Environment Variable, Bash, and the omniauth-twitter gem, Oh My.
date: '2013-09-25T13:37:00.000-04:00'
author: Allison McMillan
tags:
- environment variables
- rails
- ruby
- omniauth-twitter
- bash
modified_time: '2013-09-25T14:19:54.630-04:00'
blogger_id: tag:blogger.com,1999:blog-6054545261088815023.post-3425983787921996000
blogger_orig_url: http://allisonsherenmcmillan.blogspot.com/2013/09/environment-variable-bash-and-omniauth.html
---

I just started building a new application and decided that I'd like people to sign in via Facebook or Twitter which meant installing the <a href="http://rubygems.org/gems/omniauth-twitter" target="_blank">omniauth-twitter gem</a> (and the omniauth-facebook gem but I'm not quite there yet).<br /><br />My first challenge was to figure out how to keep my secret token a secret. Everyone says you never commit your secret stuff into Github, which makes sense but I didn't know how else to do it. In order to keep the tokens a secret, you need to store them as environment variables on your computer so that they can be called by the application when it is running. I stored my <code>twitter_key</code>; and <code>twitter_secret</code> as environment variable in ~ /.bashrc. Which led to an error of uninitialized omniauth and a timeout. I then learned that environment variables need to be uppercase so I re-saved them as <code>TWITTER_KEY</code> and <code>TWITTER_SECRET</code> (Thanks to <a href="http://twitter.com/betsythemuffin">Betsy</a> for help on this one). This is what it looks like: <br /><br /><pre>export TWITTER_KEY=your_key_goes_here<br />export TWITTER_SECRET=your_secret_goes_here<br /></pre><br />Then I got a different error. When I clicked, "Sign in with Twitter" the /auth/twitter path lead to a 401 oauth::unauthorized. Looking at the trace, the last errors had to do with requesting and receiving the tokens. I tried to see if the key showed up by calling <br /><br /><pre>$ echo $TWITTER_KEY <br /></pre><br />in the terminal and at first it did return, but when I ran the rails console and tried<br /><br /><pre>ENV['TWITTER_KEY'] <br /></pre><br /><br />which should have yielded the same result, I got nil. I also tried utilizing the pry gem to check if the variables were being sourced from my initializer like this:<br /><br /><pre>OmniAuth.config.logger = Rails.logger<br /><br />Rails.application.config.middleware.use OmniAuth::Builder do<br />puts "key: #{ENV['TWITTER_KEY']}"<br />puts "secret: #{ENV['TWITTER_SECRET']}"<br />binding.pry<br /><br />provider :twitter, ENV['TWITTER_KEY'], ENV['TWITTER_SECRET']<br />end<br /></pre><br />and also got nil, and finally, I went back into the original window where I called <code> $echo TWITTER_KEY</code> tried again, and it wasn't working. So the issue was definitely that the tokens were not being read in the application.<br /><br />The first solution (which was simple but turned out not to be the actual problem) was that I had been typing source ~/.bashrc into 1 terminal tab and then opening up my server in a different tab (talk about a hand-to-forehead moment but I didn't realize that the environments didn't copy over if you were in the same window but a different tab). When I did that, it worked. Clicking "Sign in with Twitter" lead to the appropriate /auth/twitter path where the user could approve the application. But again, that wasn't the route of the problem. The main issue was that I had to run the source code each time in order for the variable to be loaded into the system.<br /><br />I tried to put the same export lines (the environment variables) as above into ~/.profile instead of in ~/.bashrc. I also put an echo line into ~/.profile:<br /><br /><pre>echo "leading env, yay"<br /></pre><br />Putting an echo line will help see if things are set up correctly. If the shell is loading everything properly, when I open the shell or a new tab, I should see "loading env, yay" at the top.<br /><br />But when I tried ~/.profile, nothing showed up. Then, I put the same echo line into ~/.bash_profile (thanks <a href="http://www.twitter.com/crsexton" target="_blank">Chris</a> for this suggestion!) and that worked! So things were working and set up correctly. To understand it a little better, Chris found <a href="http://superuser.com/questions/320065/bashrc-not-sourced-in-iterm-mac-os-x/320068#320068" target="_blank">this link</a> from a great SuperUser answer. Basically, bash will only source ~/.bashrc or ~/.bash_profile. Bash looks, in order, for ~/.bash_profile, ~/.bash_login, or ~/.profile and sources whichever one it finds first. The solution is to alter the configuration. <br /><br />At the top of ~/.bash_profile put:<br /><code> Export BASH_CONF=”bash_profile” </code><br /><br />At the top of ~/.bashrc put:<br /><code> Export BASH_CONF=”bashrc” </code><br /><br />Then in your terminal window type: <code> $ echo $BASH_CONF </code> and the file that shows up is the one being sourced.<br /><br />And now my omniauth-twitter gem is working (well, at least the first part of the process is complete).<br /><br /><br /><br />